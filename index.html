<!DOCTYPE html>
<html lang="en" class="transition-colors duration-500">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ©¸ Glucose & Insulin Tracker</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/drop-of-blood/64.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    .alert-popup {
      animation: bounceIn 0.6s ease forwards;
    }
    @keyframes bounceIn {
      0% { transform: scale(0.7); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-white transition-colors duration-500 p-4">

  <!-- Dark Mode Toggle -->
  <div class="flex justify-end mb-4">
    <button id="darkModeToggle" class="bg-gray-800 text-white dark:bg-yellow-300 dark:text-black px-4 py-2 rounded shadow hover:scale-105 transition">
      ğŸŒ™ Toggle Dark Mode
    </button>
  </div>

  <!-- Title -->
  <h1 class="text-3xl font-bold text-center mb-6 text-blue-700 dark:text-blue-300">ğŸ©¸ Glucose & Insulin Tracker</h1>

  <!-- Input Form -->
  <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
    <label>Glucose Level (mg/dL)</label>
    <input type="number" id="glucoseInput" class="w-full p-2 border rounded dark:bg-gray-700"/>

    <label>Test Type</label>
    <select id="testTypeInput" onchange="toggleInputs()" class="w-full p-2 border rounded dark:bg-gray-700">
      <option value="Fasting Glucose">Fasting Glucose</option>
      <option value="Post Breakfast">Post Breakfast</option>
      <option value="Pre Lunch">Pre Lunch</option>
      <option value="Post Lunch">Post Lunch</option>
      <option value="Pre Dinner">Pre Dinner</option>
      <option value="Post Dinner">Post Dinner</option>
      <option value="3 AM Test">3 AM Test</option>
      <option value="Bedtime">Bedtime</option>
      <option value="Random">Random Test</option>
    </select>

    <div id="timePickerDiv" class="hidden">
      <label>Custom Time</label>
      <input type="time" id="timeOnlyInput" class="w-full p-2 border rounded dark:bg-gray-700"/>
    </div>

    <label>Date</label>
    <input type="date" id="dateInput" class="w-full p-2 border rounded dark:bg-gray-700"/>

    <div id="insulinInputDiv" class="hidden">
      <label>Insulin Dose (Units)</label>
      <input type="number" id="insulinInput" class="w-full p-2 border rounded dark:bg-gray-700"/>
    </div>

    <div id="glargineInputDiv" class="mb-2 hidden">
      <label>Glargine Insulin (Units)</label>
      <input type="number" id="glargineInput" class="w-full p-2 border rounded dark:bg-gray-700"/>
    </div>

    <button onclick="addGlucose()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 hover:scale-105 transition">â• Add Entry</button>
  </div>

  <!-- Chart Section -->
  <div class="max-w-4xl mx-auto mt-8 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
    <canvas id="glucoseChart" class="mb-4"></canvas>
    <button onclick="downloadReport()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hover:scale-105 transition">ğŸ“„ Download PDF Report</button>
  </div>

  <!-- Reminder Settings -->
  <div class="max-w-2xl mx-auto mt-8 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
    <h2 class="text-xl font-semibold text-purple-600 dark:text-purple-300 mb-4">â° Set Custom Reminder Times</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Each input is labeled with ID matching testType formatting -->
      <label>Fasting Glucose: <input type="time" id="fastingglucose" class="border p-1 rounded w-full dark:bg-gray-700" /></label>
      <label>Post Breakfast: <input type="time" id="postbreakfast" class="border p-1 rounded w-full dark:bg-gray-700" /></label>
      <label>Pre Lunch: <input type="time" id="prelunch" class="border p-1 rounded w-full dark:bg-gray-700" /></label>
      <label>Post Lunch: <input type="time" id="postlunch" class="border p-1 rounded w-full dark:bg-gray-700" /></label>
      <label>Pre Dinner: <input type="time" id="predinner" class="border p-1 rounded w-full dark:bg-gray-700" /></label>
      <label>Post Dinner: <input type="time" id="postdinner" class="border p-1 rounded w-full dark:bg-gray-700" /></label>
      <label>3 AM Test: <input type="time" id="3amtest" class="border p-1 rounded w-full dark:bg-gray-700" /></label>
    </div>
    <button onclick="saveTimes()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 hover:scale-105 transition">ğŸ’¾ Save Times</button>
  </div>

  <!-- Alert Sound -->
  <audio id="alertSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

  <!-- Entries Table -->
  <div class="max-w-4xl mx-auto mt-8 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
    <h2 class="text-xl font-bold text-red-600 dark:text-red-300 mb-4">ğŸ“ All Entries</h2>
    <ul id="entryList" class="space-y-2"></ul>
  </div>

  <script>
    let entries = [];
    let chart;

    function addGlucose() {
      const glucose = parseInt(document.getElementById("glucoseInput").value);
      const testType = document.getElementById("testTypeInput").value;
      const date = document.getElementById("dateInput").value;
      const time = document.getElementById("timeOnlyInput").value;
      const insulin = document.getElementById("insulinInput").value;
      const glargine = document.getElementById("glargineInput").value;

      const timeDisplay = testType === "Random Test" ? time : testType;

      const entry = {
        glucose,
        testType: timeDisplay,
        date,
        insulin,
        glargine
      };

      entries.push(entry);
      renderChart();
      renderEntries();
      checkGlucoseLevel(glucose);

      document.getElementById("glucoseInput").value = "";
    }

    function renderEntries() {
      const entryList = document.getElementById("entryList");
      entryList.innerHTML = "";

      entries.forEach((entry, index) => {
        const li = document.createElement("li");
        li.className = "flex justify-between bg-gray-200 dark:bg-gray-700 p-2 rounded";
        li.innerHTML = `<span>${entry.date} - ${entry.testType}: ${entry.glucose} mg/dL - Insulin: ${entry.insulin || "N/A"}, Glargine: ${entry.glargine || "N/A"}</span>
          <button onclick="deleteEntry(${index})" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸ Delete</button>`;
        entryList.appendChild(li);
      });
    }

    function deleteEntry(index) {
      entries.splice(index, 1);
      renderEntries();
      renderChart();
    }

    function renderChart() {
      const labels = entries.map(e => e.testType + ' ' + e.date);
      const data = entries.map(e => e.glucose);

      const ctx = document.getElementById("glucoseChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Glucose Level (mg/dL)",
            data,
            borderColor: "#3b82f6",
            backgroundColor: "#93c5fd",
            tension: 0.4,
            fill: true
          }]
        }
      });
    }

    function downloadReport() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Glucose Report", 14, 16);

      const rows = entries.map(e => [e.date, e.testType, e.glucose, e.insulin || "-", e.glargine || "-"]);
      doc.autoTable({
        head: [["Date", "Test Type", "Glucose", "Insulin", "Glargine"]],
        body: rows,
        startY: 20
      });

      doc.save("glucose_report.pdf");
    }

    function checkGlucoseLevel(glucose) {
      const alertSound = document.getElementById("alertSound");
      if (glucose > 350) {
        alertSound.play();
        alert("âš ï¸ High Glucose: Immediate action required!");
      } else if (glucose < 70) {
        alertSound.play();
        alert("âš ï¸ Low Glucose: Glucose treatment needed!");
      }
    }

    function toggleInputs() {
      const selected = document.getElementById("testTypeInput").value;
      document.getElementById("timePickerDiv").classList.toggle("hidden", selected !== "Random Test");
      document.getElementById("insulinInputDiv").classList.toggle("hidden", selected === "3 AM Test");
      document.getElementById("glargineInputDiv").classList.toggle("hidden", selected === "3 AM Test");
    }

    function saveTimes() {
      const testTypes = ["fastingglucose","postbreakfast","prelunch","postlunch","predinner","postdinner","3amtest"];
      testTypes.forEach(type => {
        const time = document.getElementById(type).value;
        localStorage.setItem(type, time);
      });
    }

    document.getElementById("darkModeToggle").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
    });
  </script>
</body>
</html>
